{% extends 'black.html' %}
{% load static %}

{% block title %}Power BI Embedded sample{% endblock title %}

{% block content %}
<main class="row">
  <section id="text-container" class="embed-container col-lg-4 col-md-4 col-sm-4 mb-5 ml-5 mt-5">
    <div>
      <p>This sample is developed using Django framework.
        <br>
        In order to see a different report, make changes to the <i>config.py</i> file.
      </p>
      <p>Code is present in the following files:
        <ol>
          <li>views.py</li>
          <li>aadservice.py</li>
          <li>pbiembedservice.py</li>
          <li>index.js</li>
          <li>index.html</li>
          <li>index.css</li>
        </ol>
      </p>
    </div>
  </section>
  <section id="report-container" class="embed-container col-lg-offset-4 col-lg-7 col-md-offset-5 col-md-7 col-sm-offset-5 col-sm-7 mt-5">
  </section>

  <!-- Used to display report embed error messages -->
  <section class="error-container m-5">
  </section>
</main>
{% endblock content %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/powerbi-client/2.15.1/powerbi.min.js" integrity="sha512-OWIl8Xrlo8yQjWN5LcMz5SIgNnzcJqeelChqPMIeQGnEFJ4m1fWWn668AEXBrKlsuVbvDebTUJGLRCtRCCiFkg==" crossorigin="anonymous"></script>
<script src="{% static 'js/index.js' %}"></script>

<script>
  function fetchData() {
    // Realiza la solicitud AJAX al servidor
    var csrf_token = document.getElementsByName("csrfmiddlewaretoken")[0].value;
    var xhr = new XMLHttpRequest();
    xhr.responseType = "text";
    xhr.open("POST", "{% url 'bi_app:reporte_embed' %}", true);
    xhr.setRequestHeader("X-CSRFToken", csrf_token);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = function () {
      if (this.readyState === XMLHttpRequest.DONE) {
        handleServerResponse(this.status, this.responseText);
      }
    };
    var database = window.sessionStorage.getItem("database_name");
    xhr.send("database_select=" + encodeURIComponent(database));
  }

  // Verifica si la p√°gina se carga con un valor de base de datos almacenado en sessionStorage
  if (window.sessionStorage.getItem("database_name")) {
    fetchData();
  }

  function handleServerResponse(status, responseText) {
    if (status === 200) {
      // Parsea la respuesta JSON
      var jsonResponse = JSON.parse(responseText);
  
      // Obtiene la URL de la clave 'url_powerbi'
      var powerbiUrl = jsonResponse.url_powerbi;
      console.log(this.status, powerbiUrl);
  
      // Obtiene el elemento iframe
      var powerbi_iframe = document.getElementById("powerbi-iframe");
  
      // Establece la URL recibida como el atributo src del iframe
      powerbi_iframe.src = powerbiUrl;
    } else {
      console.error("Error en la solicitud:", responseText);
    }
  }
</script>
{% endblock script %}
